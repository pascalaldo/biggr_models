<script src="https://unpkg.com/escher@1.8.1/dist/escher.min.js"></script>
<style>
	svg.escher-svg #mouse-node {
		fill: none;
	}

	svg.escher-svg #canvas {
		stroke: #ccc;
		stroke-width: 7px;
		fill: white;
	}

	svg.escher-svg .resize-rect {
		fill: black;
		opacity: 0;
		stroke: none;
	}

	svg.escher-svg .label {
		font-family: sans-serif;
		font-style: italic;
		font-weight: bold;
		font-size: 8px;
		fill: black;
		stroke: none;
		text-rendering: optimizelegibility;
		cursor: default;
	}

	svg.escher-svg .reaction-label {
		font-size: 30px;
		fill: rgb(13, 110, 253);
		text-rendering: optimizelegibility;
	}

	svg.escher-svg .node-label {
		font-size: 20px;
	}

	svg.escher-svg .gene-label {
		font-size: 18px;
		fill: rgb(32, 32, 120);
		text-rendering: optimizelegibility;
		cursor: default;
	}

	svg.escher-svg .text-label .label {
		font-size: 50px;
	}

	svg.escher-svg .text-label-input {
		font-size: 50px;
	}

	svg.escher-svg .node-circle {
		stroke-width: 4px;
	}

	svg.escher-svg .midmarker-circle,
	svg.escher-svg .multimarker-circle {
		fill: white;
		fill-opacity: 0.2;
		stroke: rgb(50, 50, 50);
		display: none !important;
	}

	svg.escher-svg g.selected .node-circle {
		stroke-width: 6px;
		stroke: rgb(20, 113, 199);
	}

	svg.escher-svg g.selected .label {
		fill: rgb(20, 113, 199);
	}

	svg.escher-svg .metabolite-circle {
		stroke: #d36b2a;
		fill: #ff883f;
	}

	svg.escher-svg g.selected .metabolite-circle {
		stroke: rgb(5, 2, 0);
	}

	svg.escher-svg .segment {
		stroke: #334E75;
		stroke-width: 10px;
		fill: none;
	}

	svg.escher-svg .arrowhead {
		fill: #334E75;
	}

	svg.escher-svg .stoichiometry-label-rect {
		fill: white;
		opacity: 0.5;
	}

	svg.escher-svg .stoichiometry-label {
		fill: #334E75;
		font-size: 17px;
	}

	svg.escher-svg .membrane {
		fill: none;
		stroke: rgb(255, 187, 0);
	}

	svg.escher-svg .brush .extent {
		fill-opacity: 0.1;
		fill: black;
		stroke: #fff;
		shape-rendering: crispEdges;
	}

	svg.escher-svg #brush-container .background {
		fill: none;
	}

	svg.escher-svg .bezier-circle {
		fill: rgb(255, 255, 255);
	}

	svg.escher-svg .bezier-circle.b1 {
		stroke: red;
	}

	svg.escher-svg .bezier-circle.b2 {
		stroke: blue;
	}

	svg.escher-svg .connect-line {
		stroke: rgb(200, 200, 200);
	}

	svg.escher-svg .direction-arrow {
		cursor: default;
		stroke: black;
		stroke-width: 1px;
		fill: white;
		opacity: 0.3;
	}

	svg.escher-svg .start-reaction-target {
		stroke: rgb(100, 100, 100);
		fill: none;
		opacity: 0.5;
	}

	svg.escher-svg .rotation-center-line {
		stroke: red;
		stroke-width: 5px;
	}

	svg.escher-svg .highlight {
		fill: #D97000;
		text-decoration: underline;
	}

	svg.escher-svg .node-to-combine {
		stroke-width: 12px !important;
	}

	.escher-container {
		position: absolute !important;
	}

	.escher-container .button.btn,
	.escher-container .buttonGroup.btn {
		border-radius: none !important;
		background: rgb(51, 122, 183) !important;
		border: 1px solid rgb(43.35, 103.7, 155.55) !important;
		color: white !important;
		font-weight: normal !important;
	}

	.legend-container {
		display: none !important;
	}
</style>
<script>
	function show_escher_map(module_bigg_id, model_bigg_id, map_url, zoom_to_reaction = null) {
		fetch(map_url).then(x => x.json()).then(map_data => show_escher_map_final(module_bigg_id, model_bigg_id, map_data, zoom_to_reaction))
	}
	function show_escher_map_final(module_bigg_id, model_bigg_id, map_data, zoom_to_reaction) {
		var map_sel = escher.libs.d3_select('#map-container-' + module_bigg_id);
		var zoom_to_element = null;
		if (zoom_to_reaction !== null) {
			zoom_to_element = {type: "reaction", id: (Object.keys(map_data[1].reactions).find(key => map_data[1].reactions[key].bigg_id === zoom_to_reaction))};
		}
		const reaction_data = {};
		reaction_data[zoom_to_reaction] = 1;
		const data = {
			// defaults
			map_data: map_data,
			model_data: null,
			embedded_css: null,
			options: {
				menu: 'zoom',
				scroll_behavior: 'none',
				never_ask_before_quit: true,
				enable_keys: false,
				enable_editing: false,
				reaction_styles: ['color'],
				fill_screen: false,
				first_load_callback: (() => {add_click_listeners(map_sel, model_bigg_id);}),
				zoom_to_element: zoom_to_element,
				reaction_data: reaction_data,
				enable_tooltips: [],
			}
		};
		escher.Builder(data.map_data, data.model_data, data.embedded_css,
			map_sel, data.options);

	}
	function b64DecodeUnicode(str) {
		return decodeURIComponent(Array.prototype.map.call(atob(str), function (c) {
			return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
		}).join(''))
	}
	function add_click_listeners(map_sel, model_bigg_id) {
		map_sel.selectAll('.node,.reaction,.reaction-label,.node-label').style('cursor', 'pointer')
		map_sel.selectAll('.node').on('click', function (d) {
			// console.log('clicked ', d)
			let bigg_id = d.target.__data__.bigg_id;
			if (bigg_id) {
				window.location.href = '/models/' + model_bigg_id + '/metabolites/' + bigg_id;
			}
		})
		map_sel.selectAll('.reaction').on('click', function (d) {
			let bigg_id = d.target.__data__.bigg_id;
			// console.log('clicked ', d)
			if (bigg_id) {
				url = '/models/' + model_bigg_id + '/reactions/' + bigg_id
				window.location.href = url
			}
		})
	}
</script>
